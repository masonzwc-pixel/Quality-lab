<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกผลการทำ EQA และ Interlab Comparison</title>
    <style>
        /* General Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
            flex-wrap: wrap;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            min-width: 150px;
        }

        .nav-tab:hover {
            background: #e9ecef;
            color: #2c3e50;
        }

        .nav-tab.active {
            background: white;
            color: #2c3e50;
            border-bottom-color: #3498db;
        }
        
        .nav-dropdown {
            position: relative;
        }

        .nav-dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 0 0 8px 8px;
        }

        .nav-dropdown:hover .nav-dropdown-content {
            display: block;
        }

        .nav-dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
            font-weight: 600;
        }

        .nav-dropdown-content a:hover {
            background-color: #f1f1f1;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.5s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Sections */
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border-left: 5px solid #3498db;
        }

        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }

        /* Test Results & Summary */
        .test-results-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #e9ecef;
        }
        
        .qa-record-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }
        .qa-record-item:last-child {
            margin-bottom: 0;
        }
        
        .test-result-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }
        .test-result-item:last-child {
            margin-bottom: 0;
        }

        .result-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-pass {
            background: #d4edda;
            color: #155724;
        }

        .status-fail {
            background: #f8d7da;
            color: #721c24;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-pending {
            background: #cce5ff;
            color: #004085;
        }
        
        .status-na {
            background: #e9ecef;
            color: #495057;
        }

        .summary-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #3498db;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }

        /* Icons & Modals */
        .icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: relative;
            background: white;
            padding: 30px;
            width: 90%;
            max-width: 700px;
            border-radius: 15px;
            animation: slideDown 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content h3 {
            margin-bottom: 10px;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .user-info {
            text-align: right;
            color: #6c757d;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        /* Admin Tab */
        .admin-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border-left: 5px solid #27ae60;
        }
        
        .admin-section-sub {
            background: #f1f3f5;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .user-list, .test-list, .eqa-list, .interlab-list, .lab-list, .status-list, .audit-list {
            margin-top: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .audit-list {
            font-family: 'Courier New', Courier, monospace;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .list-item.group-header {
            background-color: #e9ecef;
            font-weight: bold;
        }

        .list-item:last-child {
            border-bottom: none;
        }
        
        .list-item-content {
            flex-grow: 1;
        }

        .modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .nav-tab {
                flex: none;
                min-width: auto;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8em;
            }

            .qa-record-item, .test-result-item {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔬 ระบบบันทึกผลการทำ EQA และ Interlab Comparison</h1>
            <p>ห้องปฏิบัติการเทคนิคการแพทย์</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('login')" id="loginTab">
                👤 เข้าสู่ระบบ
            </button>
            
            <div class="nav-dropdown" id="entryDropdown" style="display: none;">
                <button class="nav-tab">📝 บันทึกข้อมูล</button>
                <div class="nav-dropdown-content">
                    <a href="#" onclick="showTab('entry-eqa')">บันทึก EQA</a>
                    <a href="#" onclick="showTab('entry-interlab')">บันทึก Interlab</a>
                </div>
            </div>
            
            <button class="nav-tab" onclick="showTab('results')" id="resultsTab" style="display: none;">
                📊 ดูผลการทดสอบ
            </button>
            <button class="nav-tab" onclick="showTab('summary')" id="summaryTab" style="display: none;">
                📈 สรุปผลประจำปี
            </button>
            <button class="nav-tab" onclick="showTab('admin')" id="adminTab" style="display: none;">
                ⚙️ จัดการระบบ
            </button>
            <button class="nav-tab" onclick="logout()" id="logoutTab" style="display: none;">
                🚪 ออกจากระบบ
            </button>
        </div>

        <div id="login" class="tab-content active">
            <div class="form-section">
                <h3>👤 เข้าสู่ระบบ</h3>
                <div style="max-width: 400px; margin: 0 auto;">
                    <div class="form-group">
                        <label for="username">ชื่อผู้ใช้:</label>
                        <input type="text" id="username" placeholder="กรอกชื่อผู้ใช้" required>
                    </div>
                    <div class="form-group">
                        <label for="password">รหัสผ่าน:</label>
                        <input type="password" id="password" placeholder="กรอกรหัสผ่าน" required>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button type="button" class="btn btn-primary" onclick="login()">
                            🔑 เข้าสู่ระบบ
                        </button>
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: #e8f4fd; border-radius: 10px; border-left: 4px solid #3498db;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">ข้อมูลสำหรับทดสอบระบบ:</h4>
                    <div style="display: grid; gap: 15px;">
                        <div>
                            <strong>🧑‍⚕️ เจ้าหน้าที่ห้องปฏิบัติการ:</strong><br>
                            ชื่อผู้ใช้: <code>lab_user</code> | รหัสผ่าน: <code>lab123</code>
                        </div>
                        <div>
                            <strong>👨‍💼 ผู้ดูแลระบบ (Admin):</strong><br>
                            ชื่อผู้ใช้: <code>admin</code> | รหัสผ่าน: <code>admin123</code>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="entry-eqa" class="tab-content">
            <div class="user-info">
                เข้าสู่ระบบโดย: <strong id="currentUserEQA"></strong>
            </div>

            <div class="form-section">
                <h3>📝 บันทึกข้อมูล EQA</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="eqaReceiveDate">วันที่รับตัวอย่าง:</label>
                        <input type="date" id="eqaReceiveDate" required>
                    </div>
                    <div class="form-group">
                        <label for="eqaSubmitDate">วันที่ส่งผลตัวอย่าง:</label>
                        <input type="date" id="eqaSubmitDate" required>
                    </div>
                    <div class="form-group">
                        <label for="eqaProjectName">ชื่อโครงการประเมินคุณภาพ:</label>
                        <select id="eqaProjectName" required>
                            <option value="">เลือกโครงการ</option>
                        </select>
                    </div>
                    <div class="form-group" id="eqaProjectCustomGroup" style="display: none;">
                        <label for="eqaProjectCustom">ระบุโครงการอื่น:</label>
                        <input type="text" id="eqaProjectCustom" placeholder="ระบุชื่อโครงการ">
                    </div>
                    <div class="form-group">
                        <label for="eqaAssessmentRound">ครั้งที่ทำการประเมิน:</label>
                        <input type="text" id="eqaAssessmentRound" placeholder="เช่น ครั้งที่ 1/2025" required>
                    </div>
                    <div class="form-group">
                        <label for="eqaAgency">หน่วยงาน EQA:</label>
                        <input type="text" id="eqaAgency" placeholder="ชื่อหน่วยงานที่จัดทำ EQA" required>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>🧪 รายการทดสอบ</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="eqaTestName">ชื่อรายการทดสอบ:</label>
                        <select id="eqaTestName" required>
                            <option value="">เลือกโครงการก่อน</option>
                        </select>
                    </div>
                    <div class="form-group" id="eqaTestCustomGroup" style="display: none;">
                        <label for="eqaTestCustom">ระบุรายการทดสอบอื่น:</label>
                        <input type="text" id="eqaTestCustom" placeholder="ระบุชื่อรายการทดสอบ">
                    </div>
                </div>

                <div class="form-grid" style="margin-top: 20px;">
                    <div class="form-group">
                        <label for="eqaTestResult">ผลการทดสอบ:</label>
                        <textarea id="eqaTestResult" rows="4" placeholder="ระบุผลการทดสอบ..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="eqaResultStatus">สถานะผล:</label>
                        <select id="eqaResultStatus" required>
                            <option value="">เลือกสถานะ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="eqaComments">หมายเหตุ/ข้อเสนอแนะ:</label>
                        <textarea id="eqaComments" rows="3" placeholder="หมายเหตุเพิ่มเติม..."></textarea>
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: center; gap: 10px; display: flex; justify-content: center; flex-wrap: wrap;">
                    <button type="button" class="btn btn-primary" onclick="addEQATestResult()">
                        ➕ เพิ่มผลการทดสอบ
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveEQARecord()">
                        💾 บันทึกข้อมูล EQA
                    </button>
                    <button type="button" class="btn btn-warning" onclick="clearAllForms('eqa')">
                        🗑️ ล้างฟอร์ม
                    </button>
                </div>
            </div>

            <div class="test-results-container" id="eqaTestResultsContainer" style="display: none;">
                <h4>ผลการทดสอบที่เพิ่มแล้ว:</h4>
                <div id="eqaTestResultsList"></div>
            </div>
        </div>
        
        <div id="entry-interlab" class="tab-content">
            <div class="user-info">
                เข้าสู่ระบบโดย: <strong id="currentUserInterlab"></strong>
            </div>

            <div class="form-section">
                <h3>📝 บันทึกข้อมูล Interlab Comparison</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="interlabReceiveDate">วันที่รับตัวอย่าง:</label>
                        <input type="date" id="interlabReceiveDate" required>
                    </div>
                    <div class="form-group">
                        <label for="interlabSubmitDate">วันที่ส่งผลตัวอย่าง:</label>
                        <input type="date" id="interlabSubmitDate" required>
                    </div>
                    <div class="form-group">
                        <label for="interlabLabName">ชื่อห้องปฏิบัติการคู่เทียบ:</label>
                        <select id="interlabLabName" required>
                            <option value="">เลือกห้องปฏิบัติการ</option>
                        </select>
                    </div>
                    <div class="form-group" id="interlabLabCustomGroup" style="display: none;">
                        <label for="interlabLabCustom">ระบุห้องปฏิบัติการอื่น:</label>
                        <input type="text" id="interlabLabCustom" placeholder="ระบุชื่อห้องปฏิบัติการ">
                    </div>
                    <div class="form-group">
                        <label for="interlabComparisonRound">ครั้งที่ทำการเทียบ:</label>
                        <input type="text" id="interlabComparisonRound" placeholder="เช่น ครั้งที่ 1/2025" required>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>🧪 รายการทดสอบ</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="interlabTestName">ชื่อรายการทดสอบ:</label>
                        <input type="text" id="interlabTestName" placeholder="ระบุชื่อรายการทดสอบ" required>
                    </div>
                    <div class="form-group">
                        <label for="interlabResultStatus">สถานะผล:</label>
                        <select id="interlabResultStatus" required>
                            <option value="">เลือกสถานะ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="interlabComments">หมายเหตุ/ข้อเสนอแนะ:</label>
                        <textarea id="interlabComments" rows="3" placeholder="หมายเหตุเพิ่มเติม..."></textarea>
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: center; gap: 10px; display: flex; justify-content: center; flex-wrap: wrap;">
                    <button type="button" class="btn btn-primary" onclick="addInterlabTestResult()">
                        ➕ เพิ่มผลการทดสอบ
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveInterlabRecord()">
                        💾 บันทึกข้อมูล Interlab
                    </button>
                    <button type="button" class="btn btn-warning" onclick="clearAllForms('interlab')">
                        🗑️ ล้างฟอร์ม
                    </button>
                </div>
            </div>

            <div class="test-results-container" id="interlabTestResultsContainer" style="display: none;">
                <h4>ผลการทดสอบที่เพิ่มแล้ว:</h4>
                <div id="interlabTestResultsList"></div>
            </div>
        </div>

        <div id="results" class="tab-content">
            <div class="form-section">
                <h3>🔍 ค้นหาผลการทดสอบ</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="searchType">ประเภทข้อมูล:</label>
                        <select id="searchType" onchange="toggleSearchParams()">
                            <option value="eqa">EQA</option>
                            <option value="interlab">Interlab Comparison</option>
                        </select>
                    </div>
                    <div class="form-group" id="searchProjectGroup">
                        <label for="searchProject">โครงการ:</label>
                        <select id="searchProject">
                            <option value="">ทั้งหมด</option>
                        </select>
                    </div>
                    <div class="form-group" id="searchLabGroup" style="display: none;">
                        <label for="searchLab">ห้องปฏิบัติการคู่เทียบ:</label>
                        <select id="searchLab">
                            <option value="">ทั้งหมด</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="searchYear">ปี:</label>
                        <select id="searchYear">
                            <option value="">ทั้งหมด</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="searchStatus">สถานะ:</label>
                        <select id="searchStatus">
                            <option value="">ทั้งหมด</option>
                        </select>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" class="btn btn-primary" onclick="searchResults()">
                        🔎 ค้นหา
                    </button>
                </div>
            </div>
            
            <div class="test-results-container">
                <h4>ผลการค้นหา: <span id="resultsCount">0</span> รายการ</h4>
                <div id="searchResultsList">
                    <p style="text-align: center; color: #6c757d;">ไม่มีข้อมูลที่ตรงกับการค้นหา</p>
                </div>
            </div>
        </div>

        <div id="summary" class="tab-content">
            <div class="form-section">
                <h3>📈 สรุปผลประจำปี</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="summaryType">ประเภทข้อมูล:</label>
                        <select id="summaryType" onchange="populateSummaryYears(); generateSummary()">
                            <option value="eqa">EQA</option>
                            <option value="interlab">Interlab Comparison</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="summaryYear">เลือกปีที่ต้องการสรุป:</label>
                        <select id="summaryYear" onchange="generateSummary()">
                            <option value="">เลือกปี</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="summaryContent" style="display: none;">
                <div class="summary-card">
                    <h3>ผลสรุปประจำปี <span id="summaryYearLabel"></span> (<span id="summaryTypeLabel">EQA</span>)</h3>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span class="stat-number" id="totalTests">0</span>
                            <span class="stat-label">รายการทดสอบทั้งหมด</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="passRate">0%</span>
                            <span class="stat-label">อัตราการผ่าน</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="failCount">0</span>
                            <span class="stat-label">จำนวนที่ไม่ผ่าน</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="warningCount">0</span>
                            <span class="stat-label">จำนวนที่เตือน</span>
                        </div>
                    </div>
                </div>
                
                <div class="summary-card" style="text-align: center;">
                    <h3>กราฟสรุปผล</h3>
                    <div style="width: 80%; max-width: 400px; margin: 20px auto;">
                        <canvas id="summaryChart"></canvas>
                    </div>
                </div>
                
                <div class="summary-card">
                    <h3>รายละเอียดผลที่ไม่ผ่าน</h3>
                    <div class="test-results-container">
                        <div id="failResultsList">
                            <p style="text-align: center; color: #6c757d;">ไม่มีผลการทดสอบที่ไม่ผ่าน</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin" class="tab-content">
            <div class="user-info">
                เข้าสู่ระบบโดย: <strong id="adminUser"></strong>
            </div>

            <div class="admin-section">
                <h3>👥 จัดการผู้ใช้งาน</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="newUsername">ชื่อผู้ใช้ใหม่:</label>
                        <input type="text" id="newUsername" placeholder="ชื่อผู้ใช้">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">รหัสผ่าน:</label>
                        <input type="password" id="newPassword" placeholder="รหัสผ่าน">
                    </div>
                    <div class="form-group">
                        <label for="newRole">สิทธิ์การใช้งาน:</label>
                        <select id="newRole">
                            <option value="lab">เจ้าหน้าที่ห้องปฏิบัติการ</option>
                            <option value="admin">ผู้ดูแลระบบ</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-success" onclick="addUser()">
                        ➕ เพิ่มผู้ใช้งาน
                    </button>
                </div>
                <div class="user-list" id="userList">
                    </div>
            </div>
            
            <div class="admin-section">
                <h3>📝 จัดการโครงการและรายการทดสอบ (EQA)</h3>
                <div class="form-group">
                    <label for="adminProjectName">เลือกโครงการ:</label>
                    <select id="adminProjectName" onchange="displayProjectDetails()">
                        <option value="">--เลือกโครงการ--</option>
                    </select>
                </div>
                <div id="projectAdminSection" style="display: none;">
                    <div class="form-grid" style="margin-top: 15px;">
                         <div class="form-group">
                             <label for="editProjectNameInput">แก้ไขชื่อโครงการ:</label>
                             <input type="text" id="editProjectNameInput">
                         </div>
                         <div class="form-group">
                             <label for="editEqaAgencyInput">แก้ไขหน่วยงาน EQA:</label>
                             <input type="text" id="editEqaAgencyInput">
                         </div>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn btn-primary" onclick="saveProjectChanges()">บันทึกการแก้ไขโครงการ</button>
                        <button class="btn btn-danger" onclick="deleteProject()">ลบโครงการ</button>
                    </div>
                    <hr style="margin: 20px 0;">
                </div>
                
                <div id="testItemsAdmin" style="display: none;">
                    <h4>รายการทดสอบในโครงการ <span id="currentProjectName"></span></h4>
                    <div class="form-grid" style="margin-top: 15px;">
                        <div class="form-group">
                            <label for="newTestName">ชื่อรายการทดสอบใหม่:</label>
                            <input type="text" id="newTestName" placeholder="เช่น CBC">
                        </div>
                        <div class="form-group">
                            <label for="newTestGroup">กลุ่มการทดสอบ:</label>
                            <select id="newTestGroup">
                                <option value="Hematology">Hematology</option>
                                <option value="Immunology">Immunology</option>
                                <option value="Clinical Chemistry">Clinical Chemistry</option>
                                <option value="Microscopy">Microscopy</option>
                                <option value="Microbiology">Microbiology</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 15px; text-align: center;">
                        <button class="btn btn-success" onclick="addProjectTestItem()">
                            ➕ เพิ่มรายการทดสอบ
                        </button>
                    </div>
                    
                    <div class="test-list" id="projectTestList">
                        </div>
                </div>
            </div>
            
            <div class="admin-section">
                <h3>🏢 จัดการห้องปฏิบัติการคู่เทียบ (Interlab)</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="newLabName">ชื่อห้องปฏิบัติการคู่เทียบใหม่:</label>
                        <input type="text" id="newLabName" placeholder="เช่น Lab A, Lab B">
                    </div>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-success" onclick="addInterlabLab()">
                        ➕ เพิ่มห้องปฏิบัติการ
                    </button>
                </div>
                <div class="lab-list" id="interlabLabList">
                    </div>
            </div>

            <div class="admin-section">
                <h3>🚦 จัดการสถานะผล (EQA & Interlab)</h3>
                <div class="admin-section-sub">
                    <h4>สถานะ EQA</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="newEqaStatusName">ชื่อสถานะใหม่:</label>
                            <input type="text" id="newEqaStatusName" placeholder="เช่น Waiting">
                        </div>
                        <div class="form-group">
                            <label for="newEqaStatusValue">ค่าในระบบ (English):</label>
                            <input type="text" id="newEqaStatusValue" placeholder="เช่น waiting">
                        </div>
                        <div class="form-group">
                            <label for="newEqaStatusColor">สี (CSS):</label>
                            <input type="text" id="newEqaStatusColor" placeholder="เช่น #cce5ff">
                        </div>
                    </div>
                    <div style="margin-top: 15px; text-align: center;">
                        <button class="btn btn-success" onclick="addStatus('eqa')">
                            ➕ เพิ่มสถานะ EQA
                        </button>
                    </div>
                    <div class="status-list" id="eqaStatusList"></div>
                </div>

                <div class="admin-section-sub">
                    <h4>สถานะ Interlab</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="newInterlabStatusName">ชื่อสถานะใหม่:</label>
                            <input type="text" id="newInterlabStatusName" placeholder="เช่น No Result">
                        </div>
                        <div class="form-group">
                            <label for="newInterlabStatusValue">ค่าในระบบ (English):</label>
                            <input type="text" id="newInterlabStatusValue" placeholder="เช่น no_result">
                        </div>
                        <div class="form-group">
                            <label for="newInterlabStatusColor">สี (CSS):</label>
                            <input type="text" id="newInterlabStatusColor" placeholder="เช่น #e9ecef">
                        </div>
                    </div>
                    <div style="margin-top: 15px; text-align: center;">
                        <button class="btn btn-success" onclick="addStatus('interlab')">
                            ➕ เพิ่มสถานะ Interlab
                        </button>
                    </div>
                    <div class="status-list" id="interlabStatusList"></div>
                </div>
            </div>

            <div class="admin-section">
                <h3>📚 จัดการข้อมูล EQA ทั้งหมด</h3>
                <div class="eqa-list" id="eqaList">
                    </div>
            </div>

            <div class="admin-section">
                <h3>📚 จัดการข้อมูล Interlab Comparison ทั้งหมด</h3>
                <div class="interlab-list" id="interlabList">
                    </div>
            </div>
            
            <div class="admin-section">
                <h3>📜 ประวัติการตรวจสอบ (Audit Log)</h3>
                <div class="audit-list" id="auditLogList">
                    </div>
            </div>
        </div>
    </div>

    <div id="editEqaModal" class="modal" onclick="closeModal(event, 'editEqaModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close" onclick="closeModal(null, 'editEqaModal')">&times;</span>
            <h3 id="editEqaModalTitle"></h3>
            <div id="editEqaModalBody">
                </div>
            <div style="text-align: center; margin-top: 20px;" id="editEqaModalButtons">
                <button class="btn btn-primary" onclick="saveEqaRecordChanges()">บันทึกการแก้ไข</button>
            </div>
        </div>
    </div>
    
    <div id="editInterlabModal" class="modal" onclick="closeModal(event, 'editInterlabModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close" onclick="closeModal(null, 'editInterlabModal')">&times;</span>
            <h3 id="editInterlabModalTitle"></h3>
            <div id="editInterlabModalBody">
                </div>
            <div style="text-align: center; margin-top: 20px;" id="editInterlabModalButtons">
                <button class="btn btn-primary" onclick="saveInterlabRecordChanges()">บันทึกการแก้ไข</button>
            </div>
        </div>
    </div>

    <div id="editTestModal" class="modal" onclick="closeModal(event, 'editTestModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close" onclick="closeModal(null, 'editTestModal')">&times;</span>
            <h3 id="editTestModalTitle"></h3>
            <div id="editTestModalBody">
                </div>
            <div style="text-align: center; margin-top: 20px;" id="editTestModalButtons">
                </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // --- Data Management using localStorage ---
        function loadData() {
            const storedUsers = localStorage.getItem('users');
            const storedEQAs = localStorage.getItem('eqas');
            const storedInterlabs = localStorage.getItem('interlabs');
            const storedProjects = localStorage.getItem('projects');
            const storedInterlabLabs = localStorage.getItem('interlabLabs');
            const storedStatuses = localStorage.getItem('statuses');
            const storedAuditLogs = localStorage.getItem('auditLogs');

            const defaultUsers = [
                { username: 'lab_user', password: 'lab123', role: 'lab' },
                { username: 'admin', password: 'admin123', role: 'admin' }
            ];
            
            const defaultProjects = [
                {
                    projectName: 'NEQAS-TH',
                    eqaAgency: 'National External Quality Assessment',
                    testItems: {
                        'Hematology': ['CBC', 'PT', 'aPTT'],
                        'Clinical Chemistry': ['Glucose', 'Cholesterol', 'Triglyceride'],
                        'Immunology': ['HBsAg', 'Anti-HIV'],
                        'Microbiology': [],
                        'Microscopy': [],
                        'Other': []
                    }
                },
                {
                    projectName: 'CAP',
                    eqaAgency: 'College of American Pathologists',
                    testItems: {
                        'Hematology': ['CBC'],
                        'Immunology': ['VDRL', 'TPHA'],
                        'Clinical Chemistry': ['BUN', 'Creatinine'],
                        'Microbiology': [],
                        'Microscopy': [],
                        'Other': []
                    }
                },
                {
                    projectName: 'UKNEQAS',
                    eqaAgency: 'UK National External Quality Assessment',
                    testItems: {
                        'Hematology': ['INR'],
                        'Immunology': [],
                        'Clinical Chemistry': [],
                        'Microbiology': [],
                        'Microscopy': [],
                        'Other': []
                    }
                }
            ];

            const defaultInterlabLabs = [
                'Lab A', 'Lab B', 'Lab C'
            ];
            
            const defaultStatuses = {
                eqa: [
                    { name: 'ผ่าน', value: 'pass', color: '#d4edda', text_color: '#155724' },
                    { name: 'ไม่ผ่าน', value: 'fail', color: '#f8d7da', text_color: '#721c24' },
                    { name: 'เตือน', value: 'warning', color: '#fff3cd', text_color: '#856404' },
                    { name: 'รอผล', value: 'pending', color: '#cce5ff', text_color: '#004085' },
                ],
                interlab: [
                    { name: 'ผ่าน', value: 'pass', color: '#d4edda', text_color: '#155724' },
                    { name: 'ไม่ผ่าน', value: 'fail', color: '#f8d7da', text_color: '#721c24' },
                    { name: 'N/A', value: 'na', color: '#e9ecef', text_color: '#495057' },
                ]
            };

            return {
                users: storedUsers ? JSON.parse(storedUsers) : defaultUsers,
                eqas: storedEQAs ? JSON.parse(storedEQAs) : [],
                interlabs: storedInterlabs ? JSON.parse(storedInterlabs) : [],
                projects: storedProjects ? JSON.parse(storedProjects) : defaultProjects,
                interlabLabs: storedInterlabLabs ? JSON.parse(storedInterlabLabs) : defaultInterlabLabs,
                statuses: storedStatuses ? JSON.parse(storedStatuses) : defaultStatuses,
                auditLogs: storedAuditLogs ? JSON.parse(storedAuditLogs) : []
            };
        }

        function saveData() {
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('eqas', JSON.stringify(eqas));
            localStorage.setItem('interlabs', JSON.stringify(interlabs));
            localStorage.setItem('projects', JSON.stringify(projects));
            localStorage.setItem('interlabLabs', JSON.stringify(interlabLabs));
            localStorage.setItem('statuses', JSON.stringify(statuses));
            localStorage.setItem('auditLogs', JSON.stringify(auditLogs));
        }

        let { users, eqas, interlabs, projects, interlabLabs, statuses, auditLogs } = loadData();
        let currentEQATestResults = [];
        let currentInterlabTestResults = [];
        let loggedInUser = null;
        let myChart; // Variable to hold the chart instance
        
        // --- Audit Trail Function ---
        function addLog(action, details) {
            const log = {
                timestamp: new Date().toISOString(),
                user: loggedInUser ? loggedInUser.username : 'System',
                action: action,
                details: details
            };
            auditLogs.push(log);
            saveData();
            console.log('Audit Log:', log);
        }

        // --- UI and Tab Control Functions ---
        function showTab(tabId) {
            // Check if user is logged in before allowing access to certain tabs
            if (!loggedInUser && tabId !== 'login') {
                showTab('login');
                return;
            }

            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const entryDropdownBtn = document.querySelector('#entryDropdown .nav-tab');
            if (entryDropdownBtn) {
                entryDropdownBtn.classList.remove('active');
            }
            
            const activeTabElement = document.getElementById(tabId);
            if (activeTabElement) {
                activeTabElement.style.display = 'block';
                activeTabElement.classList.add('active');
            }
            
            const correspondingNavTab = document.getElementById(tabId + 'Tab');
            if (correspondingNavTab) {
                 correspondingNavTab.classList.add('active');
            } else if (tabId.startsWith('entry-') && entryDropdownBtn) {
                entryDropdownBtn.classList.add('active');
            }

            if (tabId === 'results') {
                populateSearchFilters();
                searchResults();
            }
            if (tabId === 'summary') {
                populateSummaryYears();
                document.getElementById('summaryContent').style.display = 'none';
            }
            if (tabId === 'admin') {
                if (loggedInUser && loggedInUser.role === 'admin') {
                    displayUsers();
                    populateAdminProjects();
                    displayInterlabLabs();
                    displayStatus('eqa');
                    displayStatus('interlab');
                    displayEqaRecords();
                    displayInterlabRecords();
                    displayAuditLogs();
                } else {
                    alert('คุณไม่มีสิทธิ์เข้าถึงหน้านี้');
                    showTab('entry-eqa'); // Redirect admin to EQA entry if not logged in as admin
                }
            }
            if (tabId === 'entry-eqa') {
                document.getElementById('currentUserEQA').textContent = loggedInUser.username;
                populateEQAProjectNames();
                populateEQATestDropdown('');
                populateStatusDropdown('eqa', 'eqaResultStatus');
                clearAllForms('eqa');
            }
            if (tabId === 'entry-interlab') {
                document.getElementById('currentUserInterlab').textContent = loggedInUser.username;
                populateInterlabLabs();
                populateStatusDropdown('interlab', 'interlabResultStatus');
                clearAllForms('interlab');
            }
        }
        
        // --- Login/Logout Functions ---
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                loggedInUser = user;
                alert(`เข้าสู่ระบบสำเร็จ! ยินดีต้อนรับ, ${loggedInUser.username}`);
                addLog('LOGIN', `User ${loggedInUser.username} logged in.`);

                document.getElementById('loginTab').style.display = 'none';
                document.getElementById('entryDropdown').style.display = 'block';
                document.getElementById('resultsTab').style.display = 'flex';
                document.getElementById('summaryTab').style.display = 'flex';
                document.getElementById('logoutTab').style.display = 'flex';

                if (loggedInUser.role === 'admin') {
                    document.getElementById('adminTab').style.display = 'flex';
                    document.getElementById('adminUser').textContent = loggedInUser.username;
                } else {
                    document.getElementById('adminTab').style.display = 'none';
                }

                showTab('entry-eqa');
            } else {
                alert('ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง');
            }
        }

        function logout() {
            addLog('LOGOUT', `User ${loggedInUser.username} logged out.`);
            loggedInUser = null;
            currentEQATestResults = [];
            currentInterlabTestResults = [];
            alert('ออกจากระบบเรียบร้อย');
            
            document.getElementById('loginTab').style.display = 'flex';
            document.getElementById('entryDropdown').style.display = 'none';
            document.getElementById('resultsTab').style.display = 'none';
            document.getElementById('summaryTab').style.display = 'none';
            document.getElementById('adminTab').style.display = 'none';
            document.getElementById('logoutTab').style.display = 'none';

            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showTab('login');
        }

        // --- EQA Entry Tab Functions ---
        function populateEQAProjectNames() {
            const projectNameSelect = document.getElementById('eqaProjectName');
            projectNameSelect.innerHTML = '<option value="">เลือกโครงการ</option>';
            
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.projectName;
                option.textContent = project.projectName;
                projectNameSelect.appendChild(option);
            });
            const otherOption = document.createElement('option');
            otherOption.value = 'Other';
            otherOption.textContent = 'อื่น ๆ';
            projectNameSelect.appendChild(otherOption);
        }
        
        document.getElementById('eqaProjectName').addEventListener('change', (e) => {
            const selectedProject = e.target.value;
            const customProjectGroup = document.getElementById('eqaProjectCustomGroup');
            customProjectGroup.style.display = (selectedProject === 'Other') ? 'flex' : 'none';
            
            const eqaAgencyInput = document.getElementById('eqaAgency');
            if (selectedProject && selectedProject !== 'Other') {
                const project = projects.find(p => p.projectName === selectedProject);
                if (project) {
                    eqaAgencyInput.value = project.eqaAgency;
                }
            } else {
                eqaAgencyInput.value = '';
            }
            
            populateEQATestDropdown(selectedProject);
        });

        function populateEQATestDropdown(projectName) {
            const testNameSelect = document.getElementById('eqaTestName');
            testNameSelect.innerHTML = '<option value="">เลือกรายการทดสอบ</option>';
            
            if (projectName && projectName !== 'Other') {
                const project = projects.find(p => p.projectName === projectName);
                if (project) {
                    const testGroups = project.testItems;
                    for (const group in testGroups) {
                        if (testGroups[group].length > 0) {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = group;
                            testGroups[group].forEach(test => {
                                const option = document.createElement('option');
                                option.value = test;
                                option.textContent = test;
                                optgroup.appendChild(option);
                            });
                            testNameSelect.appendChild(optgroup);
                        }
                    }
                }
            }
            
            const otherTestOption = document.createElement('option');
            otherTestOption.value = 'other_test';
            otherTestOption.textContent = 'ระบุรายการทดสอบอื่น...';
            testNameSelect.appendChild(otherTestOption);
        }

        document.getElementById('eqaTestName').addEventListener('change', (e) => {
            const customTestGroup = document.getElementById('eqaTestCustomGroup');
            customTestGroup.style.display = (e.target.value === 'other_test') ? 'flex' : 'none';
        });

        function addEQATestResult() {
            const testNameInput = document.getElementById('eqaTestName');
            const testResult = document.getElementById('eqaTestResult').value;
            const resultStatus = document.getElementById('eqaResultStatus').value;
            const comments = document.getElementById('eqaComments').value;

            let testName = testNameInput.value;
            if (testName === 'other_test') {
                testName = document.getElementById('eqaTestCustom').value;
            }
            
            if (!testName || !testResult || !resultStatus) {
                alert('กรุณากรอกข้อมูลรายการทดสอบให้ครบถ้วน');
                return;
            }

            const testRecord = {
                testName,
                testResult,
                resultStatus,
                comments
            };
            currentEQATestResults.push(testRecord);
            displayCurrentEQATestResults();
            
            document.getElementById('eqaTestName').value = '';
            document.getElementById('eqaTestCustom').value = '';
            document.getElementById('eqaTestResult').value = '';
            document.getElementById('eqaResultStatus').value = '';
            document.getElementById('eqaComments').value = '';
            document.getElementById('eqaTestCustomGroup').style.display = 'none';
            populateEQATestDropdown(document.getElementById('eqaProjectName').value);
        }

        function displayCurrentEQATestResults() {
            const listContainer = document.getElementById('eqaTestResultsList');
            const container = document.getElementById('eqaTestResultsContainer');
            listContainer.innerHTML = '';
            
            if (currentEQATestResults.length > 0) {
                container.style.display = 'block';
                currentEQATestResults.forEach((test, index) => {
                    const statusObj = statuses.eqa.find(s => s.value === test.resultStatus);
                    const statusText = statusObj ? statusObj.name : 'N/A';
                    const statusColor = statusObj ? statusObj.color : '#e9ecef';
                    const statusTextColor = statusObj ? statusObj.text_color : '#495057';
                    
                    const testItem = document.createElement('div');
                    testItem.className = 'test-result-item';
                    testItem.innerHTML = `
                        <div>
                            <strong>${test.testName}</strong><br>
                            <span>ผล: ${test.testResult}</span><br>
                            <small>หมายเหตุ: ${test.comments || '-'}</small>
                        </div>
                        <span class="result-status" style="background-color: ${statusColor}; color: ${statusTextColor};">${statusText}</span>
                        <button class="btn btn-danger" style="padding: 8px 12px;" onclick="removeEQATestResult(${index})">ลบ</button>
                    `;
                    listContainer.appendChild(testItem);
                });
            } else {
                container.style.display = 'none';
            }
        }

        function removeEQATestResult(index) {
            currentEQATestResults.splice(index, 1);
            displayCurrentEQATestResults();
        }

        function saveEQARecord() {
            if (currentEQATestResults.length === 0) {
                alert('กรุณาเพิ่มรายการทดสอบอย่างน้อย 1 รายการ');
                return;
            }

            const receiveDate = document.getElementById('eqaReceiveDate').value;
            const submitDate = document.getElementById('eqaSubmitDate').value;
            const projectNameInput = document.getElementById('eqaProjectName');
            const assessmentRound = document.getElementById('eqaAssessmentRound').value;
            const eqaAgency = document.getElementById('eqaAgency').value;
            
            let projectName = projectNameInput.value;
            if (projectName === 'Other') {
                projectName = document.getElementById('eqaProjectCustom').value;
            }

            if (!receiveDate || !submitDate || !projectName || !assessmentRound || !eqaAgency) {
                alert('กรุณากรอกข้อมูลทั่วไปให้ครบถ้วน');
                return;
            }

            const newEQARecord = {
                id: Date.now(),
                type: 'eqa',
                receiveDate,
                submitDate,
                projectName,
                assessmentRound,
                eqaAgency,
                tests: [...currentEQATestResults],
                createdBy: loggedInUser.username,
                createdAt: new Date().toISOString()
            };

            eqas.push(newEQARecord);
            saveData(); // Save to localStorage
            addLog('ADD_EQA', `Added new EQA record for project "${newEQARecord.projectName}" (Round: ${newEQARecord.assessmentRound})`);
            alert('บันทึกข้อมูล EQA เรียบร้อยแล้ว!');
            
            clearAllForms('eqa');
            console.log('Saved EQA Records:', eqas);
        }

        // --- Interlab Entry Tab Functions ---
        function populateInterlabLabs() {
            const labNameSelect = document.getElementById('interlabLabName');
            labNameSelect.innerHTML = '<option value="">เลือกห้องปฏิบัติการ</option>';
            interlabLabs.forEach(lab => {
                const option = document.createElement('option');
                option.value = lab;
                option.textContent = lab;
                labNameSelect.appendChild(option);
            });
            const otherOption = document.createElement('option');
            otherOption.value = 'Other';
            otherOption.textContent = 'อื่น ๆ';
            labNameSelect.appendChild(otherOption);
        }

        document.getElementById('interlabLabName').addEventListener('change', (e) => {
            const customLabGroup = document.getElementById('interlabLabCustomGroup');
            customLabGroup.style.display = (e.target.value === 'Other') ? 'flex' : 'none';
        });

        function addInterlabTestResult() {
            const testName = document.getElementById('interlabTestName').value;
            const resultStatus = document.getElementById('interlabResultStatus').value;
            const comments = document.getElementById('interlabComments').value;
            
            if (!testName || !resultStatus) {
                alert('กรุณากรอกข้อมูลรายการทดสอบให้ครบถ้วน');
                return;
            }

            const testRecord = { testName, resultStatus, comments };
            currentInterlabTestResults.push(testRecord);
            displayCurrentInterlabTestResults();

            document.getElementById('interlabTestName').value = '';
            document.getElementById('interlabResultStatus').value = '';
            document.getElementById('interlabComments').value = '';
        }

        function displayCurrentInterlabTestResults() {
            const listContainer = document.getElementById('interlabTestResultsList');
            const container = document.getElementById('interlabTestResultsContainer');
            listContainer.innerHTML = '';
            
            if (currentInterlabTestResults.length > 0) {
                container.style.display = 'block';
                currentInterlabTestResults.forEach((test, index) => {
                    const statusObj = statuses.interlab.find(s => s.value === test.resultStatus);
                    const statusText = statusObj ? statusObj.name : 'N/A';
                    const statusColor = statusObj ? statusObj.color : '#e9ecef';
                    const statusTextColor = statusObj ? statusObj.text_color : '#495057';
                    
                    const testItem = document.createElement('div');
                    testItem.className = 'test-result-item';
                    testItem.innerHTML = `
                        <div>
                            <strong>${test.testName}</strong><br>
                            <small>หมายเหตุ: ${test.comments || '-'}</small>
                        </div>
                        <span class="result-status" style="background-color: ${statusColor}; color: ${statusTextColor};">${statusText}</span>
                        <button class="btn btn-danger" style="padding: 8px 12px;" onclick="removeInterlabTestResult(${index})">ลบ</button>
                    `;
                    listContainer.appendChild(testItem);
                });
            } else {
                container.style.display = 'none';
            }
        }
        
        function removeInterlabTestResult(index) {
            currentInterlabTestResults.splice(index, 1);
            displayCurrentInterlabTestResults();
        }

        function saveInterlabRecord() {
            if (currentInterlabTestResults.length === 0) {
                alert('กรุณาเพิ่มรายการทดสอบอย่างน้อย 1 รายการ');
                return;
            }

            const receiveDate = document.getElementById('interlabReceiveDate').value;
            const submitDate = document.getElementById('interlabSubmitDate').value;
            const labNameInput = document.getElementById('interlabLabName');
            const comparisonRound = document.getElementById('interlabComparisonRound').value;
            
            let labName = labNameInput.value;
            if (labName === 'Other') {
                labName = document.getElementById('interlabLabCustom').value;
            }
            
            if (!receiveDate || !submitDate || !labName || !comparisonRound) {
                alert('กรุณากรอกข้อมูลทั่วไปให้ครบถ้วน');
                return;
            }

            const newInterlabRecord = {
                id: Date.now(),
                type: 'interlab',
                receiveDate,
                submitDate,
                labName,
                comparisonRound,
                tests: [...currentInterlabTestResults],
                createdBy: loggedInUser.username,
                createdAt: new Date().toISOString()
            };

            interlabs.push(newInterlabRecord);
            saveData();
            addLog('ADD_INTERLAB', `Added new Interlab record for lab "${newInterlabRecord.labName}" (Round: ${newInterlabRecord.comparisonRound})`);
            alert('บันทึกข้อมูล Interlab เรียบร้อยแล้ว!');
            
            clearAllForms('interlab');
            console.log('Saved Interlab Records:', interlabs);
        }

        function clearAllForms(type) {
            if (type === 'eqa') {
                document.getElementById('eqaReceiveDate').value = '';
                document.getElementById('eqaSubmitDate').value = '';
                document.getElementById('eqaProjectName').value = '';
                document.getElementById('eqaProjectCustom').value = '';
                document.getElementById('eqaAssessmentRound').value = '';
                document.getElementById('eqaAgency').value = '';
                document.getElementById('eqaTestName').value = '';
                document.getElementById('eqaTestCustom').value = '';
                document.getElementById('eqaTestResult').value = '';
                document.getElementById('eqaResultStatus').value = '';
                document.getElementById('eqaComments').value = '';

                document.getElementById('eqaProjectCustomGroup').style.display = 'none';
                document.getElementById('eqaTestCustomGroup').style.display = 'none';

                currentEQATestResults = [];
                displayCurrentEQATestResults();
                populateEQAProjectNames(); // Repopulate projects
                populateEQATestDropdown('');
                populateStatusDropdown('eqa', 'eqaResultStatus');
            } else if (type === 'interlab') {
                document.getElementById('interlabReceiveDate').value = '';
                document.getElementById('interlabSubmitDate').value = '';
                document.getElementById('interlabLabName').value = '';
                document.getElementById('interlabLabCustom').value = '';
                document.getElementById('interlabComparisonRound').value = '';
                document.getElementById('interlabTestName').value = '';
                document.getElementById('interlabResultStatus').value = '';
                document.getElementById('interlabComments').value = '';
                
                document.getElementById('interlabLabCustomGroup').style.display = 'none';
                
                currentInterlabTestResults = [];
                displayCurrentInterlabTestResults();
                populateInterlabLabs();
                populateStatusDropdown('interlab', 'interlabResultStatus');
            }
        }
        
        // --- Status Management Functions ---
        function populateStatusDropdown(type, elementId) {
            const statusSelect = document.getElementById(elementId);
            statusSelect.innerHTML = '<option value="">เลือกสถานะ</option>';
            statuses[type].forEach(s => {
                const option = document.createElement('option');
                option.value = s.value;
                option.textContent = s.name;
                statusSelect.appendChild(option);
            });
        }
        
        function getStatusInfo(type, value) {
            return statuses[type].find(s => s.value === value) || { name: 'Unknown', color: '#e9ecef', text_color: '#495057' };
        }

        // --- Results Tab Functions ---
        function toggleSearchParams() {
            const searchType = document.getElementById('searchType').value;
            const projectGroup = document.getElementById('searchProjectGroup');
            const labGroup = document.getElementById('searchLabGroup');
            const searchStatusSelect = document.getElementById('searchStatus');
            
            searchStatusSelect.innerHTML = '<option value="">ทั้งหมด</option>';
            statuses[searchType].forEach(s => {
                const option = document.createElement('option');
                option.value = s.value;
                option.textContent = s.name;
                searchStatusSelect.appendChild(option);
            });
            
            if (searchType === 'eqa') {
                projectGroup.style.display = 'flex';
                labGroup.style.display = 'none';
            } else {
                projectGroup.style.display = 'none';
                labGroup.style.display = 'flex';
            }
            populateSearchFilters();
            searchResults();
        }

        function populateSearchFilters() {
            const searchType = document.getElementById('searchType').value;
            const records = searchType === 'eqa' ? eqas : interlabs;
            
            const years = [...new Set(records.map(r => new Date(r.receiveDate).getFullYear()))].sort((a, b) => b - a);
            const searchYearSelect = document.getElementById('searchYear');
            searchYearSelect.innerHTML = '<option value="">ทั้งหมด</option>';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                searchYearSelect.appendChild(option);
            });

            if (searchType === 'eqa') {
                const projectNames = [...new Set(records.map(r => r.projectName))].sort();
                const searchProjectSelect = document.getElementById('searchProject');
                searchProjectSelect.innerHTML = '<option value="">ทั้งหมด</option>';
                projectNames.forEach(projectName => {
                    const option = document.createElement('option');
                    option.value = projectName;
                    option.textContent = projectName;
                    searchProjectSelect.appendChild(option);
                });
            } else {
                const labNames = [...new Set(records.map(r => r.labName))].sort();
                const searchLabSelect = document.getElementById('searchLab');
                searchLabSelect.innerHTML = '<option value="">ทั้งหมด</option>';
                labNames.forEach(labName => {
                    const option = document.createElement('option');
                    option.value = labName;
                    option.textContent = labName;
                    searchLabSelect.appendChild(option);
                });
            }
        }

        function searchResults() {
            const searchType = document.getElementById('searchType').value;
            const searchYear = document.getElementById('searchYear').value;
            const searchStatus = document.getElementById('searchStatus').value;
            const resultsList = document.getElementById('searchResultsList');
            resultsList.innerHTML = '';
            
            let sourceRecords = searchType === 'eqa' ? eqas : interlabs;
            let filteredResults = [];
            
            const searchProject = document.getElementById('searchProject').value;
            const searchLab = document.getElementById('searchLab').value;

            sourceRecords.forEach(record => {
                const recordYear = new Date(record.receiveDate).getFullYear().toString();
                
                let projectMatch = true;
                if (searchType === 'eqa' && searchProject) {
                    projectMatch = record.projectName === searchProject;
                }
                
                let labMatch = true;
                if (searchType === 'interlab' && searchLab) {
                    labMatch = record.labName === searchLab;
                }
                
                const yearMatch = !searchYear || recordYear === searchYear;

                if (projectMatch && labMatch && yearMatch) {
                    record.tests.forEach((test, testIndex) => {
                        const statusMatch = !searchStatus || test.resultStatus === searchStatus;
                        if (statusMatch) {
                            filteredResults.push({ ...test, recordId: record.id, parentRecord: record, type: searchType, testIndex: testIndex });
                        }
                    });
                }
            });
            
            document.getElementById('resultsCount').textContent = filteredResults.length;

            if (filteredResults.length > 0) {
                filteredResults.forEach(result => {
                    const statusObj = getStatusInfo(result.type, result.resultStatus);
                    const statusText = statusObj.name;
                    const statusColor = statusObj.color;
                    const statusTextColor = statusObj.text_color;
                    
                    const recordName = result.type === 'eqa' ? `${result.parentRecord.projectName} (${result.parentRecord.assessmentRound})` : `${result.parentRecord.labName} (${result.parentRecord.comparisonRound})`;

                    const resultItem = document.createElement('div');
                    resultItem.className = 'test-result-item';
                    resultItem.innerHTML = `
                        <div>
                            <strong>รายการ: ${result.testName} (${recordName})</strong><br>
                            ${result.parentRecord.eqaAgency ? `<span>หน่วยงาน: ${result.parentRecord.eqaAgency}</span><br>` : ''}
                            ${result.testResult ? `<span>ผลการทดสอบ: ${result.testResult}</span><br>` : ''}
                            <small>หมายเหตุ: ${result.comments || '-'}</small>
                        </div>
                        <span class="result-status" style="background-color: ${statusColor}; color: ${statusTextColor};">${statusText}</span>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" style="padding: 8px 12px;" onclick="showRecordDetail(${result.recordId}, '${result.type}')">ดู/แก้ไข</button>
                            <button class="btn btn-primary" style="padding: 8px 12px;" onclick="showTestModal(${result.recordId}, '${result.type}', ${result.testIndex})">แก้ไขรายการนี้</button>
                        </div>
                    `;
                    resultsList.appendChild(resultItem);
                });
            } else {
                resultsList.innerHTML = `<p style="text-align: center; color: #6c757d;">ไม่มีข้อมูลที่ตรงกับการค้นหา</p>`;
            }
        }

        // --- Summary Tab Functions ---
        function populateSummaryYears() {
            const summaryType = document.getElementById('summaryType').value;
            const records = summaryType === 'eqa' ? eqas : interlabs;
            
            const years = [...new Set(records.map(r => new Date(r.receiveDate).getFullYear()))].sort((a, b) => b - a);
            const summaryYearSelect = document.getElementById('summaryYear');
            summaryYearSelect.innerHTML = '<option value="">เลือกปี</option>';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                summaryYearSelect.appendChild(option);
            });
        }

        function generateSummary() {
            const selectedYear = document.getElementById('summaryYear').value;
            const summaryType = document.getElementById('summaryType').value;
            const summaryContent = document.getElementById('summaryContent');
            const failResultsList = document.getElementById('failResultsList');
            
            if (!selectedYear) {
                summaryContent.style.display = 'none';
                return;
            }

            const sourceRecords = summaryType === 'eqa' ? eqas : interlabs;
            const yearRecords = sourceRecords.filter(r => new Date(r.receiveDate).getFullYear().toString() === selectedYear);
            
            if (yearRecords.length === 0) {
                summaryContent.style.display = 'none';
                alert('ไม่พบข้อมูลในประเภทและปีที่เลือก');
                return;
            }

            summaryContent.style.display = 'block';
            document.getElementById('summaryYearLabel').textContent = selectedYear;
            document.getElementById('summaryTypeLabel').textContent = summaryType === 'eqa' ? 'EQA' : 'Interlab Comparison';

            let totalTests = 0;
            let statusCounts = {};
            let failResults = [];
            
            const relevantStatuses = statuses[summaryType];
            relevantStatuses.forEach(s => statusCounts[s.value] = 0);

            yearRecords.forEach(record => {
                record.tests.forEach(test => {
                    totalTests++;
                    if (statusCounts[test.resultStatus] !== undefined) {
                        statusCounts[test.resultStatus]++;
                    }
                    if (test.resultStatus === 'fail') {
                        failResults.push({ ...test, parentRecord: record, type: summaryType });
                    }
                });
            });

            const passCount = statusCounts['pass'] || 0;
            const failCount = statusCounts['fail'] || 0;
            const warningCount = statusCounts['warning'] || 0;
            
            const passRate = totalTests > 0 ? ((passCount / totalTests) * 100).toFixed(2) : 0;
            
            document.getElementById('totalTests').textContent = totalTests;
            document.getElementById('passRate').textContent = `${passRate}%`;
            document.getElementById('failCount').textContent = failCount;
            document.getElementById('warningCount').textContent = warningCount;
            
            failResultsList.innerHTML = '';
            if (failResults.length > 0) {
                failResults.forEach(result => {
                    const failItem = document.createElement('div');
                    failItem.className = 'test-result-item';
                    const recordName = result.type === 'eqa' ? `${result.parentRecord.projectName} (${result.parentRecord.assessmentRound})` : `${result.parentRecord.labName} (${result.parentRecord.comparisonRound})`;
                    const statusObj = getStatusInfo(result.type, result.resultStatus);
                    failItem.innerHTML = `
                        <div>
                            <strong>รายการ: ${result.testName} (${recordName})</strong><br>
                            <span>วันที่รับ: ${result.parentRecord.receiveDate}</span><br>
                            ${result.testResult ? `<span>ผลการทดสอบ: ${result.testResult}</span><br>` : ''}
                            <small>หมายเหตุ: ${result.comments || '-'}</small>
                        </div>
                        <span class="result-status" style="background-color: ${statusObj.color}; color: ${statusObj.text_color};">${statusObj.name}</span>
                    `;
                    failResultsList.appendChild(failItem);
                });
            } else {
                failResultsList.innerHTML = `<p style="text-align: center; color: #6c757d;">ไม่มีผลการทดสอบที่ไม่ผ่าน</p>`;
            }

            // Generate Chart
            if (myChart) {
                myChart.destroy();
            }
            const ctx = document.getElementById('summaryChart').getContext('2d');
            const labels = relevantStatuses.map(s => s.name);
            const data = relevantStatuses.map(s => statusCounts[s.value]);
            const colors = relevantStatuses.map(s => s.color);

            myChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'สรุปผล',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                                    const percentage = total > 0 ? (value / total * 100).toFixed(2) : 0;
                                    return `${label}: ${value} รายการ (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // --- Admin Tab Functions ---
        function displayUsers() {
            const userListDiv = document.getElementById('userList');
            userListDiv.innerHTML = '';
            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'list-item';
                userItem.innerHTML = `
                    <span class="list-item-content"><strong>${user.username}</strong> (${user.role === 'admin' ? 'ผู้ดูแลระบบ' : 'เจ้าหน้าที่'})</span>
                    <button class="btn btn-danger" style="padding: 8px 12px;" onclick="deleteUser('${user.username}')">ลบ</button>
                `;
                userListDiv.appendChild(userItem);
            });
        }
        
        function addUser() {
            const newUsername = document.getElementById('newUsername').value;
            const newPassword = document.getElementById('newPassword').value;
            const newRole = document.getElementById('newRole').value;

            if (!newUsername || !newPassword) {
                alert('กรุณากรอกชื่อผู้ใช้และรหัสผ่าน');
                return;
            }
            if (users.find(u => u.username === newUsername)) {
                alert('ชื่อผู้ใช้ซ้ำ');
                return;
            }

            users.push({ username: newUsername, password: newPassword, role: newRole });
            saveData();
            addLog('ADD_USER', `Added new user: ${newUsername} (${newRole})`);
            displayUsers();
            alert('เพิ่มผู้ใช้งานเรียบร้อย');
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
        }

        function deleteUser(username) {
            if (username === loggedInUser.username) {
                alert('ไม่สามารถลบผู้ใช้งานที่กำลังล็อกอินอยู่ได้');
                return;
            }
            if (confirm(`คุณแน่ใจหรือไม่ที่จะลบผู้ใช้งาน ${username}?`)) {
                users = users.filter(user => user.username !== username);
                saveData();
                addLog('DELETE_USER', `Deleted user: ${username}`);
                displayUsers();
            }
        }
        
        // Project Management
        function populateAdminProjects() {
            const projectNameSelect = document.getElementById('adminProjectName');
            projectNameSelect.innerHTML = '<option value="">--เลือกโครงการ--</option>';
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.projectName;
                option.textContent = project.projectName;
                projectNameSelect.appendChild(option);
            });
            // Add option to add new project
            const newProjectOption = document.createElement('option');
            newProjectOption.value = 'new_project';
            newProjectOption.textContent = '➕ เพิ่มโครงการใหม่';
            projectNameSelect.appendChild(newProjectOption);
        }
        
        function displayProjectDetails() {
            const selectedProjectName = document.getElementById('adminProjectName').value;
            const projectAdminSection = document.getElementById('projectAdminSection');
            const testItemsAdmin = document.getElementById('testItemsAdmin');
            
            if (!selectedProjectName) {
                projectAdminSection.style.display = 'none';
                testItemsAdmin.style.display = 'none';
                return;
            }
            
            if (selectedProjectName === 'new_project') {
                const newProjectName = prompt('กรุณาระบุชื่อโครงการใหม่:');
                if (newProjectName && newProjectName.trim() !== '') {
                    const newProjectEqaAgency = prompt('กรุณาระบุชื่อหน่วยงาน EQA:');
                    if (newProjectEqaAgency && newProjectEqaAgency.trim() !== '') {
                        projects.push({
                            projectName: newProjectName.trim(),
                            eqaAgency: newProjectEqaAgency.trim(),
                            testItems: {
                                'Hematology': [], 'Immunology': [], 'Clinical Chemistry': [], 
                                'Microscopy': [], 'Microbiology': [], 'Other': []
                            }
                        });
                        saveData();
                        addLog('ADD_PROJECT', `Added new EQA project: "${newProjectName}"`);
                        alert('เพิ่มโครงการใหม่เรียบร้อยแล้ว');
                        populateAdminProjects();
                        document.getElementById('adminProjectName').value = newProjectName;
                        displayProjectDetails();
                    } else {
                        alert('กรุณาระบุชื่อหน่วยงานให้ถูกต้อง');
                        populateAdminProjects();
                    }
                } else {
                    alert('กรุณาระบุชื่อโครงการให้ถูกต้อง');
                    populateAdminProjects();
                }
                return;
            }

            const project = projects.find(p => p.projectName === selectedProjectName);
            if (project) {
                projectAdminSection.style.display = 'block';
                testItemsAdmin.style.display = 'block';
                document.getElementById('editProjectNameInput').value = project.projectName;
                document.getElementById('editEqaAgencyInput').value = project.eqaAgency;
                document.getElementById('currentProjectName').textContent = project.projectName;
                displayProjectTestItems(selectedProjectName);
            } else {
                projectAdminSection.style.display = 'none';
                testItemsAdmin.style.display = 'none';
            }
        }
        
        function saveProjectChanges() {
            const selectedProjectName = document.getElementById('adminProjectName').value;
            const projectIndex = projects.findIndex(p => p.projectName === selectedProjectName);
            
            if (projectIndex === -1) return;
            
            const newProjectName = document.getElementById('editProjectNameInput').value.trim();
            const newEqaAgency = document.getElementById('editEqaAgencyInput').value.trim();
            
            if (!newProjectName || !newEqaAgency) {
                alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }
            
            // Check for duplicate project name
            const duplicateProject = projects.find((p, index) => p.projectName === newProjectName && index !== projectIndex);
            if (duplicateProject) {
                alert('ชื่อโครงการนี้มีอยู่แล้ว');
                return;
            }
            
            const oldProject = projects[projectIndex];
            if (oldProject.projectName !== newProjectName || oldProject.eqaAgency !== newEqaAgency) {
                 addLog('UPDATE_PROJECT', `Updated project "${oldProject.projectName}" -> "${newProjectName}"`);
            }
            
            // Update all EQA records related to this project
            eqas.forEach(record => {
                if (record.projectName === oldProject.projectName) {
                    record.projectName = newProjectName;
                    record.eqaAgency = newEqaAgency;
                }
            });

            projects[projectIndex].projectName = newProjectName;
            projects[projectIndex].eqaAgency = newEqaAgency;
            
            saveData();
            alert('บันทึกการแก้ไขโครงการเรียบร้อย');
            populateAdminProjects();
            document.getElementById('adminProjectName').value = newProjectName;
            displayProjectDetails();
            populateEQAProjectNames();
            populateSearchFilters();
            displayEqaRecords();
        }
        
        function deleteProject() {
            const selectedProjectName = document.getElementById('adminProjectName').value;
            if (confirm(`คุณแน่ใจหรือไม่ที่จะลบโครงการ "${selectedProjectName}"? การดำเนินการนี้จะลบรายการทดสอบทั้งหมดในโครงการนี้ด้วย`)) {
                projects = projects.filter(p => p.projectName !== selectedProjectName);
                // Also delete all EQA records related to this project
                eqas = eqas.filter(r => r.projectName !== selectedProjectName);

                saveData();
                addLog('DELETE_PROJECT', `Deleted EQA project: "${selectedProjectName}"`);
                alert('ลบโครงการเรียบร้อย');
                populateAdminProjects();
                displayProjectDetails();
                populateEQAProjectNames();
                populateSearchFilters();
                displayEqaRecords();
            }
        }
        
        // Test Item Management
        function displayProjectTestItems(projectName) {
            const project = projects.find(p => p.projectName === projectName);
            const projectTestListDiv = document.getElementById('projectTestList');
            projectTestListDiv.innerHTML = '';
            
            if (!project) return;
            
            const testGroups = project.testItems;
            
            const hasTestItems = Object.values(testGroups).some(arr => arr.length > 0);
            if (!hasTestItems) {
                projectTestListDiv.innerHTML = `<p style="text-align: center; padding: 20px; color: #6c757d;">ยังไม่มีรายการทดสอบสำหรับโครงการนี้</p>`;
                return;
            }

            for (const group in testGroups) {
                const tests = testGroups[group];
                if (tests.length > 0) {
                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'list-item group-header';
                    groupHeader.textContent = `กลุ่มงาน: ${group}`;
                    projectTestListDiv.appendChild(groupHeader);
                    
                    tests.forEach((testName, index) => {
                        const testItem = document.createElement('div');
                        testItem.className = 'list-item';
                        testItem.innerHTML = `
                            <span class="list-item-content"><strong>${testName}</strong></span>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" style="padding: 8px 12px;" onclick="editProjectTestItem('${projectName}', '${group}', ${index})">แก้ไข</button>
                                <button class="btn btn-danger" style="padding: 8px 12px;" onclick="deleteProjectTestItem('${projectName}', '${group}', ${index})">ลบ</button>
                            </div>
                        `;
                        projectTestListDiv.appendChild(testItem);
                    });
                }
            }
        }
        
        function addProjectTestItem() {
            const projectName = document.getElementById('adminProjectName').value;
            const newTestName = document.getElementById('newTestName').value.trim();
            const newTestGroup = document.getElementById('newTestGroup').value;
            
            if (!projectName || !newTestName) {
                alert('กรุณาเลือกโครงการและระบุชื่อรายการทดสอบ');
                return;
            }
            
            const project = projects.find(p => p.projectName === projectName);
            if (project) {
                if (Object.values(project.testItems).flat().includes(newTestName)) {
                    alert('ชื่อรายการทดสอบซ้ำ');
                    return;
                }
                project.testItems[newTestGroup].push(newTestName);
                saveData();
                addLog('ADD_TEST_ITEM', `Added new test item "${newTestName}" to project "${projectName}"`);
                alert('เพิ่มรายการทดสอบเรียบร้อย');
                document.getElementById('newTestName').value = '';
                displayProjectTestItems(projectName);
                populateEQATestDropdown(projectName);
            }
        }
        
        function editProjectTestItem(projectName, oldGroup, index) {
            const project = projects.find(p => p.projectName === projectName);
            if (!project) return;
            
            const oldTestName = project.testItems[oldGroup][index];
            const newTestName = prompt(`แก้ไขชื่อรายการทดสอบ "${oldTestName}"`, oldTestName);
            if (newTestName && newTestName.trim() !== '') {
                const newNameExists = Object.values(project.testItems).flat().some(name => name === newTestName.trim());
                if (newNameExists) {
                    alert('ชื่อรายการทดสอบนี้มีอยู่แล้ว');
                    return;
                }
                
                // Update test item in all EQA records
                eqas.forEach(record => {
                    if (record.projectName === projectName) {
                        record.tests.forEach(test => {
                            if (test.testName === oldTestName) {
                                test.testName = newTestName.trim();
                            }
                        });
                    }
                });

                project.testItems[oldGroup][index] = newTestName.trim();
                saveData();
                addLog('UPDATE_TEST_ITEM', `Updated test item from "${oldTestName}" to "${newTestName.trim()}" in project "${projectName}"`);
                displayProjectTestItems(projectName);
                populateEQATestDropdown(projectName);
                displayEqaRecords();
            }
        }
        
        function deleteProjectTestItem(projectName, group, index) {
            const project = projects.find(p => p.projectName === projectName);
            if (!project) return;
            
            const deletedTestName = project.testItems[group][index];
            if (confirm(`คุณแน่ใจหรือไม่ที่จะลบรายการทดสอบ "${deletedTestName}"?`)) {
                // Also delete test item from all EQA records
                eqas.forEach(record => {
                    if (record.projectName === projectName) {
                        record.tests = record.tests.filter(test => test.testName !== deletedTestName);
                    }
                });
                
                project.testItems[group].splice(index, 1);
                saveData();
                addLog('DELETE_TEST_ITEM', `Deleted test item "${deletedTestName}" from project "${projectName}"`);
                displayProjectTestItems(projectName);
                populateEQATestDropdown(projectName);
                displayEqaRecords();
                alert('ลบรายการทดสอบเรียบร้อยแล้ว');
            }
        }
        
        // Interlab Lab Management
        function displayInterlabLabs() {
            const labListDiv = document.getElementById('interlabLabList');
            labListDiv.innerHTML = '';
            if (interlabLabs.length === 0) {
                labListDiv.innerHTML = `<p style="text-align: center; padding: 20px; color: #6c757d;">ยังไม่มีห้องปฏิบัติการคู่เทียบ</p>`;
                return;
            }
            interlabLabs.forEach((lab, index) => {
                const labItem = document.createElement('div');
                labItem.className = 'list-item';
                labItem.innerHTML = `
                    <span class="list-item-content"><strong>${lab}</strong></span>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" style="padding: 8px 12px;" onclick="editInterlabLab(${index})">แก้ไข</button>
                        <button class="btn btn-danger" style="padding: 8px 12px;" onclick="deleteInterlabLab(${index})">ลบ</button>
                    </div>
                `;
                labListDiv.appendChild(labItem);
            });
        }

        function addInterlabLab() {
            const newLabName = document.getElementById('newLabName').value.trim();
            if (!newLabName) {
                alert('กรุณากรอกชื่อห้องปฏิบัติการ');
                return;
            }
            if (interlabLabs.includes(newLabName)) {
                alert('ชื่อห้องปฏิบัติการซ้ำ');
                return;
            }
            interlabLabs.push(newLabName);
            saveData();
            addLog('ADD_INTERLAB_LAB', `Added new interlab lab: "${newLabName}"`);
            displayInterlabLabs();
            populateInterlabLabs();
            document.getElementById('newLabName').value = '';
        }

        function editInterlabLab(index) {
            const oldName = interlabLabs[index];
            const newName = prompt(`แก้ไขชื่อห้องปฏิบัติการ "${oldName}"`, oldName);
            if (newName && newName.trim() !== '') {
                // Update lab name in all interlab records
                interlabs.forEach(record => {
                    if (record.labName === oldName) {
                        record.labName = newName.trim();
                    }
                });
                
                interlabLabs[index] = newName.trim();
                saveData();
                addLog('UPDATE_INTERLAB_LAB', `Updated interlab lab from "${oldName}" to "${newName.trim()}"`);
                displayInterlabLabs();
                populateInterlabLabs();
                displayInterlabRecords();
            }
        }

        function deleteInterlabLab(index) {
            const deletedName = interlabLabs[index];
            if (confirm(`คุณแน่ใจหรือไม่ที่จะลบห้องปฏิบัติการ "${deletedName}"?`)) {
                // Also delete all interlab records related to this lab
                interlabs = interlabs.filter(r => r.labName !== deletedName);
                
                interlabLabs.splice(index, 1);
                saveData();
                addLog('DELETE_INTERLAB_LAB', `Deleted interlab lab: "${deletedName}"`);
                displayInterlabLabs();
                populateInterlabLabs();
                displayInterlabRecords();
            }
        }
        
        // Status Management
        function displayStatus(type) {
            const statusListDiv = document.getElementById(`${type}StatusList`);
            statusListDiv.innerHTML = '';
            statuses[type].forEach((s, index) => {
                const statusItem = document.createElement('div');
                statusItem.className = 'list-item';
                statusItem.innerHTML = `
                    <span class="list-item-content">
                        <span style="background-color: ${s.color}; color: ${s.text_color}; padding: 5px 12px; border-radius: 20px;">${s.name}</span>
                        (<code>${s.value}</code>)
                    </span>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" style="padding: 8px 12px;" onclick="editStatus('${type}', ${index})">แก้ไข</button>
                        <button class="btn btn-danger" style="padding: 8px 12px;" onclick="deleteStatus('${type}', ${index})">ลบ</button>
                    </div>
                `;
                statusListDiv.appendChild(statusItem);
            });
        }
        
        function addStatus(type) {
            const newStatusName = document.getElementById(`new${type === 'eqa' ? 'Eqa' : 'Interlab'}StatusName`).value.trim();
            const newStatusValue = document.getElementById(`new${type === 'eqa' ? 'Eqa' : 'Interlab'}StatusValue`).value.trim().toLowerCase().replace(/\s/g, '_');
            const newStatusColor = document.getElementById(`new${type === 'eqa' ? 'Eqa' : 'Interlab'}StatusColor`).value.trim();

            if (!newStatusName || !newStatusValue || !newStatusColor) {
                alert('กรุณากรอกข้อมูลสถานะให้ครบถ้วน');
                return;
            }
            if (statuses[type].some(s => s.value === newStatusValue)) {
                alert('ค่าสถานะ (Value) นี้มีอยู่แล้ว');
                return;
            }

            statuses[type].push({ name: newStatusName, value: newStatusValue, color: newStatusColor, text_color: '#000' });
            saveData();
            addLog('ADD_STATUS', `Added new status for ${type}: "${newStatusName}" (Value: ${newStatusValue})`);
            displayStatus(type);
            populateStatusDropdown(type, `${type === 'eqa' ? 'eqa' : 'interlab'}ResultStatus`);
            populateStatusDropdown(type, 'searchStatus'); // Update search status dropdown
            
            document.getElementById(`new${type === 'eqa' ? 'Eqa' : 'Interlab'}StatusName`).value = '';
            document.getElementById(`new${type === 'eqa' ? 'Eqa' : 'Interlab'}StatusValue`).value = '';
            document.getElementById(`new${type === 'eqa' ? 'Eqa' : 'Interlab'}StatusColor`).value = '';
        }
        
        function editStatus(type, index) {
            const oldStatus = statuses[type][index];
            const newName = prompt(`แก้ไขชื่อสถานะ "${oldStatus.name}"`, oldStatus.name);
            if (newName && newName.trim() !== '') {
                const newColor = prompt(`แก้ไขรหัสสีของสถานะ "${newName.trim()}"`, oldStatus.color);
                if (newColor && newColor.trim() !== '') {
                    // Update all records with the new status name
                    const recordsToUpdate = type === 'eqa' ? eqas : interlabs;
                    recordsToUpdate.forEach(record => {
                        record.tests.forEach(test => {
                            if (test.resultStatus === oldStatus.value) {
                                test.resultStatus = oldStatus.value; // Value remains the same, name is what changes
                            }
                        });
                    });

                    statuses[type][index].name = newName.trim();
                    statuses[type][index].color = newColor.trim();
                    saveData();
                    addLog('UPDATE_STATUS', `Updated status for ${type}: "${oldStatus.name}" to "${newName.trim()}"`);
                    displayStatus(type);
                    populateStatusDropdown(type, `${type === 'eqa' ? 'eqa' : 'interlab'}ResultStatus`);
                    populateStatusDropdown(type, 'searchStatus');
                }
            }
        }
        
        function deleteStatus(type, index) {
            const statusToDelete = statuses[type][index];
            if (confirm(`คุณแน่ใจหรือไม่ที่จะลบสถานะ "${statusToDelete.name}"?`)) {
                // Check if any records are using this status
                const recordsToUpdate = type === 'eqa' ? eqas : interlabs;
                const hasRecords = recordsToUpdate.some(record => record.tests.some(test => test.resultStatus === statusToDelete.value));
                if (hasRecords) {
                    alert('ไม่สามารถลบสถานะนี้ได้ เนื่องจากยังมีข้อมูลที่ใช้งานสถานะนี้อยู่ กรุณาแก้ไขข้อมูลที่เกี่ยวข้องก่อน');
                    return;
                }

                statuses[type].splice(index, 1);
                saveData();
                addLog('DELETE_STATUS', `Deleted status for ${type}: "${statusToDelete.name}"`);
                displayStatus(type);
                populateStatusDropdown(type, `${type === 'eqa' ? 'eqa' : 'interlab'}ResultStatus`);
                populateStatusDropdown(type, 'searchStatus');
            }
        }

        // EQA Record Management
        function displayEqaRecords() {
            const eqaListDiv = document.getElementById('eqaList');
            eqaListDiv.innerHTML = '';
            if (eqas.length === 0) {
                eqaListDiv.innerHTML = `<p style="text-align: center; padding: 20px; color: #6c757d;">ยังไม่มีข้อมูล EQA</p>`;
                return;
            }

            eqas.forEach(record => {
                const recordItem = document.createElement('div');
                recordItem.className = 'qa-record-item';
                recordItem.innerHTML = `
                    <div class="list-item-content">
                        <strong>${record.projectName} (${record.assessmentRound})</strong><br>
                        <small>บันทึกโดย: ${record.createdBy} เมื่อ ${new Date(record.createdAt).toLocaleDateString('th-TH')}</small>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" style="padding: 8px 12px;" onclick="showRecordDetail(${record.id}, 'eqa')">ดู/แก้ไข</button>
                        <button class="btn btn-danger" style="padding: 8px 12px;" onclick="deleteRecord(${record.id}, 'eqa')">ลบ</button>
                    </div>
                `;
                eqaListDiv.appendChild(recordItem);
            });
        }
        
        function displayInterlabRecords() {
            const interlabListDiv = document.getElementById('interlabList');
            interlabListDiv.innerHTML = '';
            if (interlabs.length === 0) {
                interlabListDiv.innerHTML = `<p style="text-align: center; padding: 20px; color: #6c757d;">ยังไม่มีข้อมูล Interlab</p>`;
                return;
            }
            interlabs.forEach(record => {
                const recordItem = document.createElement('div');
                recordItem.className = 'qa-record-item';
                recordItem.innerHTML = `
                    <div class="list-item-content">
                        <strong>${record.labName} (${record.comparisonRound})</strong><br>
                        <small>บันทึกโดย: ${record.createdBy} เมื่อ ${new Date(record.createdAt).toLocaleDateString('th-TH')}</small>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" style="padding: 8px 12px;" onclick="showRecordDetail(${record.id}, 'interlab')">ดู/แก้ไข</button>
                        <button class="btn btn-danger" style="padding: 8px 12px;" onclick="deleteRecord(${record.id}, 'interlab')">ลบ</button>
                    </div>
                `;
                interlabListDiv.appendChild(recordItem);
            });
        }
        
        function deleteRecord(id, type) {
            if (confirm(`คุณแน่ใจหรือไม่ที่จะลบข้อมูล ${type === 'eqa' ? 'EQA' : 'Interlab'} รายการนี้?`)) {
                if (type === 'eqa') {
                    eqas = eqas.filter(record => record.id !== id);
                    addLog('DELETE_EQA', `Deleted EQA record with ID ${id}`);
                    displayEqaRecords();
                } else {
                    interlabs = interlabs.filter(record => record.id !== id);
                    addLog('DELETE_INTERLAB', `Deleted Interlab record with ID ${id}`);
                    displayInterlabRecords();
                }
                saveData();
                searchResults();
                alert('ลบข้อมูลเรียบร้อยแล้ว');
            }
        }
        
        // --- Audit Log Display ---
        function displayAuditLogs() {
            const auditLogList = document.getElementById('auditLogList');
            auditLogList.innerHTML = '';
            
            if (auditLogs.length === 0) {
                auditLogList.innerHTML = `<p style="text-align: center; padding: 20px; color: #6c757d;">ยังไม่มีประวัติการตรวจสอบ</p>`;
                return;
            }
            
            // Sort logs by timestamp descending
            const sortedLogs = auditLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            sortedLogs.forEach(log => {
                const logItem = document.createElement('div');
                logItem.className = 'list-item';
                logItem.style.flexDirection = 'column';
                logItem.style.alignItems = 'flex-start';
                logItem.style.padding = '10px 15px';
                logItem.style.background = '#f9f9f9';
                logItem.innerHTML = `
                    <small style="color: #6c757d;">
                        <strong>${new Date(log.timestamp).toLocaleDateString('th-TH')} ${new Date(log.timestamp).toLocaleTimeString('th-TH')}</strong> โดย ${log.user}
                    </small>
                    <span style="font-weight: bold; margin-top: 5px;">
                        [${log.action}]
                    </span>
                    <pre style="margin-top: 5px; background: #e9ecef; padding: 5px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;">${log.details}</pre>
                `;
                auditLogList.appendChild(logItem);
            });
        }

        // --- Modal Functions ---
        function showRecordDetail(id, type) {
            if (type === 'eqa') {
                showEqaDetail(id);
            } else {
                showInterlabDetail(id);
            }
        }
        
        function showEqaDetail(eqaId) {
            const eqaRecord = eqas.find(e => e.id === eqaId);
            if (!eqaRecord) {
                alert('ไม่พบข้อมูล EQA ที่ต้องการ');
                return;
            }

            const modal = document.getElementById('editEqaModal');
            const modalTitle = document.getElementById('editEqaModalTitle');
            const modalBody = document.getElementById('editEqaModalBody');
            const modalButtons = document.getElementById('editEqaModalButtons');
            
            modalTitle.textContent = `รายละเอียด EQA ครั้งที่ ${eqaRecord.assessmentRound}`;
            
            let html = `
                <form id="editEqaForm">
                    <input type="hidden" id="editEqaId" value="${eqaRecord.id}">
                    <input type="hidden" id="editEqaType" value="eqa">
                    <h4>ข้อมูลทั่วไป</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label><strong>โครงการ:</strong></label>
                            <input type="text" id="editProjectName" value="${eqaRecord.projectName}">
                        </div>
                        <div class="form-group">
                            <label><strong>หน่วยงาน EQA:</strong></label>
                            <input type="text" id="editEqaAgency" value="${eqaRecord.eqaAgency}">
                        </div>
                        <div class="form-group">
                            <label><strong>วันที่รับตัวอย่าง:</strong></label>
                            <input type="date" id="editReceiveDate" value="${eqaRecord.receiveDate}">
                        </div>
                        <div class="form-group">
                            <label><strong>วันที่ส่งผลตัวอย่าง:</strong></label>
                            <input type="date" id="editSubmitDate" value="${eqaRecord.submitDate}">
                        </div>
                        <div class="form-group">
                            <label><strong>ครั้งที่ทำการประเมิน:</strong></label>
                            <input type="text" id="editAssessmentRound" value="${eqaRecord.assessmentRound}">
                        </div>
                    </div>
                    <hr style="margin: 20px 0;">
                    <h4>รายการทดสอบใน Record นี้</h4>
                    <div id="modalTestsList-eqa" class="test-results-container" style="border: none; padding: 0; margin: 0;"></div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button type="button" class="btn btn-success" onclick="showTestModal(${eqaRecord.id}, 'eqa')">
                            ➕ เพิ่มรายการทดสอบใหม่
                        </button>
                    </div>
                </form>
            `;
            modalBody.innerHTML = html;
            displayTestsInModal(eqaRecord.id, 'eqa');
            
            // Allow only admin to edit main record details
            if (loggedInUser.role === 'admin') {
                modalButtons.style.display = 'block';
            } else {
                modalButtons.style.display = 'none';
                document.getElementById('editEqaForm').querySelectorAll('input, select, textarea').forEach(el => el.disabled = true);
            }
            
            modal.style.display = 'flex';
        }
        
        function showInterlabDetail(interlabId) {
            const interlabRecord = interlabs.find(e => e.id === interlabId);
            if (!interlabRecord) {
                alert('ไม่พบข้อมูล Interlab ที่ต้องการ');
                return;
            }

            const modal = document.getElementById('editInterlabModal');
            const modalTitle = document.getElementById('editInterlabModalTitle');
            const modalBody = document.getElementById('editInterlabModalBody');
            const modalButtons = document.getElementById('editInterlabModalButtons');
            
            modalTitle.textContent = `รายละเอียด Interlab Comparison ครั้งที่ ${interlabRecord.comparisonRound}`;
            
            let html = `
                <form id="editInterlabForm">
                    <input type="hidden" id="editInterlabId" value="${interlabRecord.id}">
                    <input type="hidden" id="editInterlabType" value="interlab">
                    <h4>ข้อมูลทั่วไป</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label><strong>ห้องปฏิบัติการคู่เทียบ:</strong></label>
                            <input type="text" id="editLabName" value="${interlabRecord.labName}">
                        </div>
                        <div class="form-group">
                            <label><strong>วันที่รับตัวอย่าง:</strong></label>
                            <input type="date" id="editReceiveDate-interlab" value="${interlabRecord.receiveDate}">
                        </div>
                        <div class="form-group">
                            <label><strong>วันที่ส่งผลตัวอย่าง:</strong></label>
                            <input type="date" id="editSubmitDate-interlab" value="${interlabRecord.submitDate}">
                        </div>
                        <div class="form-group">
                            <label><strong>ครั้งที่ทำการเทียบ:</strong></label>
                            <input type="text" id="editComparisonRound" value="${interlabRecord.comparisonRound}">
                        </div>
                    </div>
                    <hr style="margin: 20px 0;">
                    <h4>รายการทดสอบใน Record นี้</h4>
                    <div id="modalTestsList-interlab" class="test-results-container" style="border: none; padding: 0; margin: 0;"></div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button type="button" class="btn btn-success" onclick="showTestModal(${interlabRecord.id}, 'interlab')">
                            ➕ เพิ่มรายการทดสอบใหม่
                        </button>
                    </div>
                </form>
            `;
            modalBody.innerHTML = html;
            displayTestsInModal(interlabRecord.id, 'interlab');
            
            if (loggedInUser.role === 'admin') {
                modalButtons.style.display = 'block';
            } else {
                modalButtons.style.display = 'none';
                document.getElementById('editInterlabForm').querySelectorAll('input, select, textarea').forEach(el => el.disabled = true);
            }

            modal.style.display = 'flex';
        }

        function displayTestsInModal(recordId, type) {
            const sourceRecords = type === 'eqa' ? eqas : interlabs;
            const record = sourceRecords.find(e => e.id === recordId);
            const modalTestsList = document.getElementById(`modalTestsList-${type}`);
            modalTestsList.innerHTML = '';
            
            if (record && record.tests.length > 0) {
                record.tests.forEach((test, testIndex) => {
                    const statusObj = getStatusInfo(type, test.resultStatus);
                    const statusText = statusObj.name;
                    const statusColor = statusObj.color;
                    const statusTextColor = statusObj.text_color;

                    const testItem = document.createElement('div');
                    testItem.className = 'test-result-item';
                    testItem.innerHTML = `
                        <div class="list-item-content">
                            <strong>${test.testName}</strong><br>
                            ${test.testResult ? `<span>ผล: ${test.testResult}</span><br>` : ''}
                            <small>หมายเหตุ: ${test.comments || '-'}</small>
                        </div>
                        <span class="result-status" style="background-color: ${statusColor}; color: ${statusTextColor};">${statusText}</span>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" style="padding: 8px 12px;" onclick="showTestModal(${recordId}, '${type}', ${testIndex})">แก้ไข</button>
                            <button class="btn btn-danger" style="padding: 8px 12px;" onclick="deleteTestFromRecord(${recordId}, '${type}', ${testIndex})">ลบ</button>
                        </div>
                    `;
                    modalTestsList.appendChild(testItem);
                });
            } else {
                modalTestsList.innerHTML = `<p style="text-align: center; color: #6c757d; padding: 20px;">ไม่มีรายการทดสอบใน Record นี้</p>`;
            }
        }
        
        function saveEqaRecordChanges() {
            const eqaId = document.getElementById('editEqaId').value;
            const recordIndex = eqas.findIndex(e => e.id == eqaId);
            if (recordIndex === -1) return;
            
            const oldRecord = { ...eqas[recordIndex] };

            eqas[recordIndex].projectName = document.getElementById('editProjectName').value;
            eqas[recordIndex].eqaAgency = document.getElementById('editEqaAgency').value;
            eqas[recordIndex].receiveDate = document.getElementById('editReceiveDate').value;
            eqas[recordIndex].submitDate = document.getElementById('editSubmitDate').value;
            eqas[recordIndex].assessmentRound = document.getElementById('editAssessmentRound').value;
            
            addLog('UPDATE_EQA_RECORD_MAIN', `Updated EQA record ID ${eqaId}. Previous values: ${JSON.stringify(oldRecord)}`);

            saveData();
            alert('บันทึกการแก้ไขข้อมูล EQA เรียบร้อยแล้ว');
            closeModal(null, 'editEqaModal');
            showTab('admin');
        }

        function saveInterlabRecordChanges() {
            const interlabId = document.getElementById('editInterlabId').value;
            const recordIndex = interlabs.findIndex(e => e.id == interlabId);
            if (recordIndex === -1) return;
            
            const oldRecord = { ...interlabs[recordIndex] };

            interlabs[recordIndex].labName = document.getElementById('editLabName').value;
            interlabs[recordIndex].receiveDate = document.getElementById('editReceiveDate-interlab').value;
            interlabs[recordIndex].submitDate = document.getElementById('editSubmitDate-interlab').value;
            interlabs[recordIndex].comparisonRound = document.getElementById('editComparisonRound').value;
            
            addLog('UPDATE_INTERLAB_RECORD_MAIN', `Updated Interlab record ID ${interlabId}. Previous values: ${JSON.stringify(oldRecord)}`);

            saveData();
            alert('บันทึกการแก้ไขข้อมูล Interlab เรียบร้อยแล้ว');
            closeModal(null, 'editInterlabModal');
            showTab('admin');
        }

        function showTestModal(recordId, type, testIndex = -1) {
            const sourceRecords = type === 'eqa' ? eqas : interlabs;
            const record = sourceRecords.find(e => e.id == recordId);
            const isEditing = testIndex !== -1;
            const test = isEditing ? record.tests[testIndex] : {};
            
            const modal = document.getElementById('editTestModal');
            const modalTitle = document.getElementById('editTestModalTitle');
            const modalBody = document.getElementById('editTestModalBody');
            const modalButtons = document.getElementById('editTestModalButtons');

            modalTitle.textContent = isEditing ? 'แก้ไขรายการทดสอบ' : 'เพิ่มรายการทดสอบ';

            const statusOptions = statuses[type].map(s => 
                `<option value="${s.value}" ${test.resultStatus === s.value ? 'selected' : ''}>${s.name}</option>`
            ).join('');

            modalBody.innerHTML = `
                <form id="editTestForm">
                    <input type="hidden" id="modalRecordId" value="${recordId}">
                    <input type="hidden" id="modalRecordType" value="${type}">
                    <input type="hidden" id="modalTestIndex" value="${testIndex}">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>ชื่อรายการทดสอบ:</label>
                            <input type="text" id="modalTestName" value="${test.testName || ''}" required>
                        </div>
                        ${type === 'eqa' ? 
                            `<div class="form-group">
                                <label>ผลการทดสอบ:</label>
                                <textarea id="modalTestResult" rows="4" required>${test.testResult || ''}</textarea>
                            </div>` : ''
                        }
                        <div class="form-group">
                            <label>สถานะผล:</label>
                            <select id="modalResultStatus" required>
                                <option value="">เลือกสถานะ</option>
                                ${statusOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>หมายเหตุ/ข้อเสนอแนะ:</label>
                            <textarea id="modalComments" rows="3">${test.comments || ''}</textarea>
                        </div>
                    </div>
                </form>
            `;
            
            modalButtons.innerHTML = `
                <button type="button" class="btn btn-success" onclick="saveTestChanges()">
                    ${isEditing ? 'บันทึกการแก้ไข' : 'เพิ่มรายการทดสอบ'}
                </button>
                <button type="button" class="btn btn-danger" onclick="closeModal(null, 'editTestModal')">
                    ยกเลิก
                </button>
            `;
            
            modal.style.display = 'flex';
        }

        function saveTestChanges() {
            const recordId = document.getElementById('modalRecordId').value;
            const type = document.getElementById('modalRecordType').value;
            const testIndex = parseInt(document.getElementById('modalTestIndex').value);
            
            const sourceRecords = type === 'eqa' ? eqas : interlabs;
            const record = sourceRecords.find(e => e.id == recordId);
            if (!record) return;

            const testName = document.getElementById('modalTestName').value;
            const testResult = type === 'eqa' ? document.getElementById('modalTestResult').value : undefined;
            const resultStatus = document.getElementById('modalResultStatus').value;
            const comments = document.getElementById('modalComments').value;

            if (!testName || !resultStatus) {
                alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }
            if (type === 'eqa' && !testResult) {
                alert('กรุณากรอกผลการทดสอบ');
                return;
            }
            
            const newTest = {
                testName,
                testResult,
                resultStatus,
                comments
            };

            if (testIndex === -1) {
                // Add new test
                record.tests.push(newTest);
                addLog(`ADD_TEST_TO_${type.toUpperCase()}`, `Added new test "${newTest.testName}" to record ID ${recordId}`);
            } else {
                // Edit existing test
                const oldTest = record.tests[testIndex];
                addLog(`UPDATE_TEST_IN_${type.toUpperCase()}`, `Updated test "${oldTest.testName}" to "${newTest.testName}" in record ID ${recordId}`);
                record.tests[testIndex] = newTest;
            }
            
            saveData();
            alert('บันทึกการเปลี่ยนแปลงเรียบร้อย');
            closeModal(null, 'editTestModal');
            displayTestsInModal(recordId, type);
            // Re-render the parent modal if it's open
            const parentModalId = (type === 'eqa') ? 'editEqaModal' : 'editInterlabModal';
            if (document.getElementById(parentModalId).style.display === 'flex') {
                if (type === 'eqa') {
                    showEqaDetail(recordId);
                } else {
                    showInterlabDetail(recordId);
                }
            }
        }
        
        function deleteTestFromRecord(recordId, type, testIndex) {
            if (confirm('คุณแน่ใจหรือไม่ที่จะลบรายการทดสอบนี้?')) {
                const sourceRecords = type === 'eqa' ? eqas : interlabs;
                const record = sourceRecords.find(e => e.id === recordId);
                if (record) {
                    const deletedTest = record.tests.splice(testIndex, 1);
                    saveData();
                    addLog(`DELETE_TEST_FROM_${type.toUpperCase()}`, `Deleted test "${deletedTest[0].testName}" from record ID ${recordId}`);
                    alert('ลบรายการทดสอบเรียบร้อยแล้ว');
                    displayTestsInModal(recordId, type);
                }
            }
        }

        function closeModal(event, modalId) {
            const modal = document.getElementById(modalId);
            if (event && event.target === modal) {
                modal.style.display = 'none';
            }
            if (!event) {
                modal.style.display = 'none';
            }
        }
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initial load
        });

    </script>
</body>
</html>